#!/usr/bin/env bash

set -eu

# --------------------------------------------------------------------------------------------
# dot — dotfiles task manager
# --------------------------------------------------------------------------------------------
# Author: Matej Stastny
# Date: 2025-09-12 (YYYY-MM-DD)
# License: MIT
# Link: https://github.com/matejstastny/dotfiles
# --------------------------------------------------------------------------------------------

# Task registry -----------------------------------------------------------------------------
# Hiii, if you're using my dots, you can define more tasks here :3

declare -A TASKS=(
    [link]="$HOME/dotfiles/scripts/link.sh"
    [brew]="$HOME/dotfiles/scripts/brew.sh"
    [assets]="$HOME/dotfiles/scripts/assets.sh"
)

# Methods ------------------------------------------------------------------------------------

line() { printf '%*s\n' 40 '' | tr ' ' "-"; }

run_task() {
    local name="$1"
    local path="$2"
    echo -e "\nRunning $name..."
    line
    if ! "$path"; then
        echo "dot: Task '$name' failed"
        return 1
    fi
}

usage() {
    echo
    echo "⠀∧ ⑅ ∧"
    echo "( >  ̫ < )    DOT — dotfiles task manager"
    echo
    echo "Usage: dot [task...]"
    echo
    echo "Available tasks:"

    for key in "${!TASKS[@]}"; do
        printf "  %-10s %s\n" "$key" "${TASKS[$key]}"
    done

    echo "  all        Run all tasks in above order"
    echo
    exit 1
}

# Argument parsing --------------------------------------------------------------------------

if [ $# -eq 0 ]; then
    usage
fi

requested=("$@")
final=()

valid_tasks=()
for key in "${!TASKS[@]}"; do
    valid_tasks+=("$key")
done

for arg in "${requested[@]}"; do
    if [ "$arg" = "all" ]; then
        final=(all)
        break
    fi
    if [[ " ${valid_tasks[*]} " == *" $arg "* ]]; then
        final+=("$arg")
    else
        usage
    fi
done

# Execution ----------------------------------------------------------------------------------

for task in "${final[@]}"; do
    if [ "$task" = "all" ]; then
        for name in "${valid_tasks[@]}"; do
            run_task "$name" "${TASKS[$name]}"
        done
    else
        run_task "$task" "${TASKS[$task]}"
    fi
done
